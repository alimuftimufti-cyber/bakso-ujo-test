-- ============================================================================
-- SCRIPT DATABASE BAKSO UJO (SUPABASE)
-- CARA PAKAI:
-- 1. Buka Dashboard Supabase -> SQL Editor.
-- 2. Copy SEMUA teks di bawah ini.
-- 3. Paste di SQL Editor Supabase.
-- 4. Klik tombol RUN.
-- ============================================================================

-- 1. Pastikan ekstensi UUID aktif (untuk ID unik)
create extension if not exists "uuid-ossp";

-- 2. Tabel Kategori Menu
create table if not exists categories (
  id bigint generated by default as identity primary key,
  name text unique not null,
  created_at timestamptz default now()
);

-- 3. Tabel Menu (Produk)
create table if not exists menu_items (
  id bigint generated by default as identity primary key,
  name text not null,
  price numeric not null,
  category text not null,
  image_url text,
  default_note text,
  stock numeric,
  recipe jsonb, -- Menyimpan resep dalam format JSON
  is_active boolean default true,
  created_at timestamptz default now()
);

-- 4. Tabel Bahan Baku (Inventory)
create table if not exists ingredients (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  unit text not null, -- gram, ml, pcs, dll
  stock numeric default 0,
  created_at timestamptz default now()
);

-- 5. Tabel Profil Toko (Hanya 1 baris)
create table if not exists store_profile (
  id bigint generated by default as identity primary key,
  name text default 'Bakso Ujo',
  address text default 'Jl. Raya Bakso No. 1',
  slogan text,
  logo text,
  tax_rate numeric default 0,
  enable_tax boolean default false,
  service_charge_rate numeric default 0,
  enable_service_charge boolean default false,
  enable_table_layout boolean default false,
  auto_print_receipt boolean default false
);

-- 6. Tabel User Aplikasi (Admin, Kasir, Dapur)
-- Kita pakai tabel sendiri, bukan Supabase Auth user agar login pakai PIN sederhana
create table if not exists app_users (
  id text primary key, -- admin, cashier1, dll
  name text not null,
  pin text not null,
  role text not null check (role in ('admin', 'cashier', 'kitchen')),
  created_at timestamptz default now()
);

-- 7. Tabel Shift (Sesi Kasir)
create table if not exists shifts (
  id text primary key, -- Menggunakan timestamp string dari frontend
  start_time bigint not null,
  end_time bigint,
  start_cash numeric default 0,
  closing_cash numeric,
  revenue numeric default 0, -- Omzet kotor
  cash_revenue numeric default 0,
  non_cash_revenue numeric default 0,
  total_transactions int default 0,
  total_discount numeric default 0,
  created_at timestamptz default now()
);

-- 8. Tabel Pengeluaran (Expenses)
create table if not exists expenses (
  id bigint generated by default as identity primary key,
  shift_id text references shifts(id),
  description text not null,
  amount numeric not null,
  date bigint not null,
  created_at timestamptz default now()
);

-- 9. Tabel Pesanan (Orders)
create table if not exists orders (
  id text primary key,
  sequential_id serial, -- Nomor urut harian otomatis
  customer_name text,
  items jsonb not null, -- Detail item disimpan JSON agar fleksibel
  total numeric not null,
  subtotal numeric not null,
  discount numeric default 0,
  discount_type text,
  discount_value numeric,
  tax_amount numeric default 0,
  service_charge_amount numeric default 0,
  status text not null, -- pending, ready, completed, cancelled
  order_type text, -- Dine In, Take Away
  created_at bigint not null,
  ready_at bigint,
  completed_at bigint,
  is_paid boolean default false,
  paid_at bigint,
  payment_method text,
  shift_id text references shifts(id)
);

-- ============================================================================
-- DATA AWAL (SEEDING)
-- Agar aplikasi tidak kosong saat pertama dibuka
-- ============================================================================

-- Masukkan Kategori
insert into categories (name) values 
('Bakso'), ('Mie Ayam'), ('Tambahan'), ('Makanan'), ('Kriuk'), ('Minuman')
on conflict (name) do nothing;

-- Masukkan User Default
insert into app_users (id, name, pin, role) values 
('admin', 'Admin', '1234', 'admin'),
('cashier1', 'Kasir 1', '1111', 'cashier'),
('kitchen1', 'Dapur', '0000', 'kitchen')
on conflict (id) do nothing;

-- Masukkan Profil Toko Default
insert into store_profile (name, address, slogan) values 
('Bakso Ujo', 'Jl. Spesial Tetelan Urat Gimbal No.1', 'Nikmatnya Asli, Bikin Nagih!')
on conflict (id) do nothing;

-- Masukkan Beberapa Menu Default
insert into menu_items (name, price, category, image_url) values
('Bakso Polos', 15000, 'Bakso', 'https://picsum.photos/400/300?random=1'),
('Bakso Komplit', 23000, 'Bakso', 'https://picsum.photos/400/300?random=2'),
('Bakso Urat Gimbal', 25000, 'Bakso', 'https://picsum.photos/400/300?random=4'),
('Mie Ayam', 15000, 'Mie Ayam', 'https://picsum.photos/400/300?random=8'),
('Es Teh Manis', 5000, 'Minuman', 'https://picsum.photos/400/300?random=26'),
('Es Jeruk', 7000, 'Minuman', 'https://picsum.photos/400/300?random=28'),
('Kerupuk Kaleng', 2000, 'Kriuk', 'https://picsum.photos/400/300?random=22');


-- ============================================================================
-- PENGATURAN KEAMANAN (Row Level Security)
-- Kita buka akses (Public) agar mudah dipakai tanpa login Supabase Auth yang rumit
-- ============================================================================

alter table categories enable row level security;
alter table menu_items enable row level security;
alter table ingredients enable row level security;
alter table store_profile enable row level security;
alter table app_users enable row level security;
alter table shifts enable row level security;
alter table expenses enable row level security;
alter table orders enable row level security;

-- Membuat Policy agar semua orang (anonim) bisa Membaca & Menulis
-- (Dalam aplikasi nyata/enterprise, ini harus diperketat. Untuk UMKM pemula ini sudah cukup aman asal API Key dijaga)

create policy "Public Access Categories" on categories for all using (true);
create policy "Public Access Menu" on menu_items for all using (true);
create policy "Public Access Ingredients" on ingredients for all using (true);
create policy "Public Access Profile" on store_profile for all using (true);
create policy "Public Access Users" on app_users for all using (true);
create policy "Public Access Shifts" on shifts for all using (true);
create policy "Public Access Expenses" on expenses for all using (true);
create policy "Public Access Orders" on orders for all using (true);

-- SELESAI
